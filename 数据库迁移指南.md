# 数据库迁移指南

## 📋 变更说明

本次更新将多数据库架构（filedb + blogdb）合并为单数据库架构（multifunctional_backend），简化系统复杂度。

### 变更内容

| 项目 | 变更前 | 变更后 |
|------|--------|--------|
| 数据库数量 | 2个（filedb, blogdb） | 1个（multifunctional_backend） |
| 配置复杂度 | 需要多数据源配置 | 单数据源配置 |
| Schema 文件 | 分散在各模块 | 统一在 app-bootstrap |
| 表命名 | 无前缀 | 模块前缀（file_*, blog_*） |

## 🚀 迁移步骤

### 步骤 1：备份现有数据（如果已有数据）

```bash
# 如果你之前已经创建了数据库并有数据，请先备份
mysqldump -u root -p filedb > filedb_backup.sql
mysqldump -u root -p blogdb > blogdb_backup.sql
```

### 步骤 2：执行新的数据库初始化脚本

```bash
# 方式1：使用 MySQL 命令行导入
mysql -u root -p < app-bootstrap\src\main\resources\sql\schema.sql

# 方式2：在 MySQL 客户端中执行
# 打开 app-bootstrap/src/main/resources/sql/schema.sql 文件并执行
```

### 步骤 3：验证数据库创建成功

```sql
-- 连接到 MySQL
mysql -u root -p

-- 查看数据库
SHOW DATABASES LIKE 'multifunctional_backend';

-- 使用数据库
USE multifunctional_backend;

-- 查看所有表
SHOW TABLES;

-- 应该看到以下表：
-- +-----------------------------------+
-- | Tables_in_multifunctional_backend |
-- +-----------------------------------+
-- | blog_articles                     |
-- | blog_comments                     |
-- | blog_groups                       |
-- | file_metadata                     |
-- | users                             |
-- +-----------------------------------+
```

### 步骤 4：启动应用测试

```bash
# 在项目根目录执行
.\启动.bat

# 或者使用 Maven 命令
mvn clean install
cd app-bootstrap
mvn spring-boot:run
```

### 步骤 5：验证功能正常

1. **访问 API 文档**
   - URL: http://localhost:8080/doc.html
   - 测试文件上传/下载功能
   - 测试博客相关接口

2. **检查日志**
   ```
   应该看到类似输出：
   HikariPool-1 - Starting...
   HikariPool-1 - Added connection com.mysql.cj.jdbc.ConnectionImpl@xxxxx
   Started MultifunctionalBackendApplication in X.xxx seconds
   ```

## 📝 配置变更详情

### application.properties

**变更前：**
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/filedb?...
spring.datasource.secondary.url=jdbc:mysql://localhost:3306/blogdb?...
```

**变更后：**
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/multifunctional_backend?...
# 移除了 secondary 数据源配置
```

### MyBatisPlusConfig.kt

**变更前：**
```kotlin
@MapperScan("com.zzy.file.mapper", "com.zzy.blog.mapper")
```

**变更后：**
```kotlin
@MapperScan("com.zzy.file.mapper", "com.zzy.home.mapper")
```

## 🔄 数据迁移（如果有旧数据）

如果你之前已经有数据需要迁移：

### 方式 1：手动迁移表结构和数据

```sql
-- 1. 先创建新数据库
SOURCE app-bootstrap/src/main/resources/sql/schema.sql;

-- 2. 从旧库迁移文件数据
USE multifunctional_backend;
INSERT INTO file_metadata 
SELECT * FROM filedb.file_metadata;

-- 3. 从旧库迁移博客数据
INSERT INTO users 
SELECT id, username, password_hash, email, avatar_url, 
       NULL as storage_quota, NULL as used_storage,
       created_at, created_at as updated_at, last_login_at, 
       1 as status 
FROM blogdb.users;

INSERT INTO blog_groups 
SELECT * FROM blogdb.blog_groups;

INSERT INTO blog_articles 
SELECT * FROM blogdb.blog_articles;

INSERT INTO blog_comments 
SELECT * FROM blogdb.blog_comments;
```

### 方式 2：使用迁移脚本（推荐）

```bash
# 创建迁移脚本 migrate.sql
cat > migrate.sql << 'EOF'
-- 使用新数据库
USE multifunctional_backend;

-- 迁移文件模块数据
INSERT IGNORE INTO file_metadata 
SELECT * FROM filedb.file_metadata;

-- 迁移用户数据（合并两个 user 表）
INSERT IGNORE INTO users (id, username, password_hash, email, avatar_url, created_at, updated_at, last_login_at, status)
SELECT id, username, password_hash, email, avatar_url, created_at, created_at, last_login_at, 1
FROM blogdb.users;

-- 迁移博客数据
INSERT IGNORE INTO blog_groups SELECT * FROM blogdb.blog_groups;
INSERT IGNORE INTO blog_articles SELECT * FROM blogdb.blog_articles;
INSERT IGNORE INTO blog_comments SELECT * FROM blogdb.blog_comments;

-- 验证数据
SELECT 'file_metadata' as table_name, COUNT(*) as count FROM file_metadata
UNION ALL
SELECT 'users', COUNT(*) FROM users
UNION ALL
SELECT 'blog_groups', COUNT(*) FROM blog_groups
UNION ALL
SELECT 'blog_articles', COUNT(*) FROM blog_articles
UNION ALL
SELECT 'blog_comments', COUNT(*) FROM blog_comments;
EOF

# 执行迁移
mysql -u root -p < migrate.sql
```

## ⚠️ 注意事项

1. **默认管理员账号**
   - 用户名：`admin`
   - 密码：`admin123`
   - ⚠️ **生产环境务必修改默认密码！**

2. **开发环境自动初始化（可选）**
   如需应用启动时自动执行 SQL，在 `application.properties` 中取消注释：
   ```properties
   spring.sql.init.mode=always
   spring.sql.init.schema-locations=classpath:sql/schema.sql
   spring.sql.init.encoding=UTF-8
   ```

3. **旧的 schema.sql 文件**
   - `module-file/src/main/resources/sql/schema.sql` - 已标记为废弃
   - `module-home/src/main/resources/sql/schema.sql` - 已标记为废弃
   - 这些文件已添加废弃提示，可保留作为参考，也可删除

4. **生产环境部署**
   - 建议手动执行 SQL 脚本，而不是使用自动初始化
   - 使用数据库迁移工具（Flyway/Liquibase）管理版本升级

## ✅ 验证清单

- [ ] 新数据库 `multifunctional_backend` 创建成功
- [ ] 所有表（5个）创建成功
- [ ] 默认管理员账号插入成功
- [ ] 默认博客分组插入成功
- [ ] 应用启动无错误
- [ ] 文件上传/下载功能正常
- [ ] 博客接口功能正常
- [ ] 日志中无数据库连接错误

## 🆘 常见问题

### Q1: 启动时报错 "Unknown database 'multifunctional_backend'"
**A:** 说明数据库未创建，执行步骤2的 SQL 脚本

### Q2: 提示 "Access denied for user 'root'"
**A:** 检查 application.properties 中的数据库用户名和密码是否正确

### Q3: 旧数据库可以删除吗？
**A:** 在确认新系统运行正常且数据已迁移后，可以删除：
```sql
DROP DATABASE IF EXISTS filedb;
DROP DATABASE IF EXISTS blogdb;
```

### Q4: 如何回滚到多数据库架构？
**A:** 
1. 恢复备份的配置文件
2. 从备份恢复旧数据库
3. 重新部署旧版本代码

## 📚 相关文档

- Spring Boot 数据源配置：https://docs.spring.io/spring-boot/docs/current/reference/html/data.html
- MyBatis-Plus 官方文档：https://baomidou.com/
- MySQL 数据迁移指南：https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html

---

**迁移日期：** 2025-10-16  
**版本：** v2.0 - 单数据库架构

